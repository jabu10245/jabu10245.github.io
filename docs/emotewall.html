<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>bottest</title>
        <style>
            .emote {
                display: inline-block;
                position: absolute;
                transition: top 10s ease-out, left 10s ease-out, opacity 2s ease-out;
                width: 112px;
                height: 112px;
            }
            .emote.small, .emote.small img {
                width: 56px;
                height: 56px;
            }
            .emote.medium, .emote.medium img {
                width: 84px;
                height: 84px;
            }
        </style>
    </head>
    <body>
        <script src="tmi.min.js"></script>
        <script>
            const _debug_ = true;
            const _channel_ = "jabu10245";

            const emoteContext = {
                count: {
                    total: 0
                },
                setupEmote: simpleMovingEmotes,
            };

            const client = new tmi.Client({
                options: {
                    debug: _debug_,
                    skipUpdatingEmotesets: true,
                    skipMembership: true,
                },
                channels: [_channel_],
            });

            client.on("message", (channel, tags, message, self) => {
                if (!self && channel === `#${_channel_}`) {
                    const urls = collectEmotes(tags);
                    if (urls?.length) {
                        const size = emoteSize(urls.length);
                        urls.forEach(url => {
                            createEmote(url, emoteContext, size)
                                .then(appendImage)
                                .then(removeImage)
                                .catch(console.warn);
                        });
                    }
                }
            });

            client.connect().catch(console.error);

            function collectEmotes(tags) {
                const { emotes } = tags;
                const urls = [];

                if (emotes) {
                    Object.keys(emotes).forEach(key => {
                        const url = `https://static-cdn.jtvnw.net/emoticons/v2/${key}/default/dark/3.0`;
                        emotes[key].forEach(emote => {
                            urls.push(url);
                        })
                    });
                }

                return urls;
            }

            function emoteSize(n) {
                if (n > 5) {
                    return 'small';
                } else if (n > 1) {
                    return 'medium';
                } else {
                    return 'large';
                }
            }

            async function createEmote(url, context, size) {
                const countByURL = context.count[url] ?? 0;
                if (countByURL > 20) {
                    return Promise.reject('too many');
                }

                context.count.total += 1;
                context.count[url] = countByURL + 1;

                const time = {
                    untilAppending: 0,
                    untilRemoval: 0,
                };

                return new Promise(resolve => {
                    const element = document.createElement('div');
                    element.innerHTML = `<img src="${url}">`;

                    const emote = context.setupEmote({ element, context, url, time, size });
                    resolve(emote);
                });
            }

            async function appendImage(emote) {
                const delay = emote.time.untilAppending;

                return new Promise(resolve => setTimeout(() => {
                    document.body.appendChild(emote.element);
                    resolve(emote);
                }, delay));
            }

            async function removeImage(emote) {
                const delay = emote.time.untilRemoval;

                return new Promise(resolve => setTimeout(() => {
                    document.body.removeChild(emote.element);
                    emote.context.count.total -= 1;
                    emote.context.count[emote.url] -= 1;
                    resolve(emote);
                }, delay));
            }

            function simpleMovingEmotes(emote) {
                emote.time.untilAppending = Math.random() * 5000; // append after random delay up to 5s
                emote.time.untilRemoval = 10000;                  // remove after 10s

                emote.element.classList.add('emote');
                emote.element.classList.add(emote.size);
                emote.element.style.top = `${Math.random() * 99}%`;
                emote.element.style.left = `${Math.random() * 99}%`;
                emote.element.style.opacity = 0;

                // Start moving them after 200ms, which takes 10s.
                setTimeout(() => {
                    emote.element.style.top = `${Math.random() * 99}%`;
                    emote.element.style.left = `${Math.random() * 99}%`;
                    emote.element.style.opacity = 1;
                }, emote.time.untilAppending + 200);

                // Start fading them out after 8s, which takes 2s.
                setTimeout(() => {
                    emote.element.style.opacity = 0;
                }, emote.time.untilAppending + 8000);
                
                return emote;
            }
        </script>
    </body>
</html>